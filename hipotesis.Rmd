---
title: "Sistema de hipotesis"
author: "Maria Bonilla, Juan Guayazán y Jeronimo Quilaguy"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r }
library(dplyr)
library(ggplot2)


library(readr)
base_saludmental <- read_delim("base_saludmental.csv", 
                               delim = ";", escape_double = FALSE, trim_ws = TRUE)
```


```{r , echo=TRUE}
names(base_saludmental)[names(base_saludmental) == "Confianza vecindario y vecinos"] <- "confianza_vecinos"
names(base_saludmental)[names(base_saludmental) == "Hablar con vecinos antes del confinamiento"] <- "hablar_vecinos_antes"
names(base_saludmental)[names(base_saludmental) == "Frecuencia hablar con vecinos antes del confinamiento"] <- "freq_hablar_vecinos_antes"
names(base_saludmental)[names(base_saludmental) == "Hablar con amigos y familiares"] <- "hablar_amigos_familia"
names(base_saludmental)[names(base_saludmental) == "Hablar con amigos y familiares antes del confinamiento"] <- "hablar_amigos_familia_antes"
names(base_saludmental)[names(base_saludmental) == "Considera que usted ha cumplido con las medidas de autocuidado"] <- "cumple_autocuidado"
names(base_saludmental)[names(base_saludmental) == "Considera que sus familiares han cumplido con las medidas de autocuidado"] <- "familia_autocuidado"
names(base_saludmental)[names(base_saludmental) == "Considera que sus vecinos han cumplido con las medidas de autocuidado"] <- "vecinos_autocuidado"
names(base_saludmental)[names(base_saludmental) == "estrategia de comunicación y la información presentada por la alcaldía en relación con el COVID-19  [Clara]"] <- "info_alcaldia_clara"
names(base_saludmental)[names(base_saludmental) == "estrategia de comunicación y la información presentada por la alcaldía en relación con el COVID-19 [Suficiente]"] <- "info_alcaldia_suficiente"
names(base_saludmental)[names(base_saludmental) == "estrategia de comunicación y la información presentada por la alcaldía en relación con el COVID-19 [Verídica]"] <- "info_alcaldia_veridica"
names(base_saludmental)[names(base_saludmental) == "estrategia de comunicación y la información presentada por la alcaldía en relación con el COVID-19  [Oportuna]"] <- "info_alcaldia_oportuna"
names(base_saludmental)[names(base_saludmental) == "estrategia de comunicación y la información presentada por la alcaldía en relación con el COVID-19  [Contradictoria]"] <- "info_alcaldia_contradictoria"
names(base_saludmental)[names(base_saludmental) == "medio o medios por los que se entera de las decisiones tomadas por la alcaldía"] <- "medios_info_alcaldia"
names(base_saludmental)[names(base_saludmental) == "¿Sabe cómo actuar o a dónde acudir ante sospechas o sistemas de contagio?"] <- "sabe_actuar_covid"
names(base_saludmental)[names(base_saludmental) == "¿Cree que cuenta con la información suficiente para conocer que es el COVID-19?"] <- "info_suficiente_covid"
names(base_saludmental)[names(base_saludmental) == "Considera que la información que se le ha dado a la ciudadanía por parte de la alcaldía en relación a los riesgos asociados al COVID-19 ha sido:"] <- "info_riesgos_covid"
names(base_saludmental)[names(base_saludmental) == "Diagnosticado con COVID-19"] <- "diagnosticado_covid"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena se ha sentido ansioso o nervioso"] <- "ansioso_nervioso"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena se ha sentido decaído o deprimido"] <- "decaido_deprimido"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena se ha sentido tranquilo"] <- "tranquilo"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena, se ha sentido cercano a las personas con las que convive"] <- "cercano_convivientes"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena ha sentido interés o placer al hacer las cosas"] <- "interes_actividades"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena ha tenido problemas para dormir"] <- "problemas_dormir"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena, ha tenido desacuerdos con las personas con las que convive"] <- "desacuerdos_convivientes"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena ha sentido la necesidad de consumir bebidas alcoholicas"] <- "consumo_alcohol"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena ha sentido la necesidad de fumar cigarrillos o tabaco"] <- "consumo_tabaco"
names(base_saludmental)[names(base_saludmental) == "Durante el periodo de cuarentena ha sentido la necesidad de consumir algún tipo de sustancia psicoactiva"] <- "consumo_sustancias"
names(base_saludmental)[names(base_saludmental) == "¿De los siguientes factores, cuál o cuáles le han generado mayor preocupación o intranquilidad durante la cuarentena? Puede marcar varias opciones"] <- "factores_preocupacion"
names(base_saludmental)[names(base_saludmental) == "¿qué tanto apoyo siente que ha recibido por parte de las siguientes personas o grupos durante el periodo de cuarentena? [Su pareja]"] <- "apoyo_pareja"
names(base_saludmental)[names(base_saludmental) == "¿qué tanto apoyo siente que ha recibido por parte de las siguientes personas o grupos durante el periodo de cuarentena? [Su familia]"] <- "apoyo_familia"
names(base_saludmental)[names(base_saludmental) == "¿qué tanto apoyo siente que ha recibido por parte de las siguientes personas o grupos durante el periodo de cuarentena? [Sus amigos]"] <- "apoyo_amigos"
names(base_saludmental)[names(base_saludmental) == "¿qué tanto apoyo siente que ha recibido por parte de las siguientes personas o grupos durante el periodo de cuarentena? [Su empleador o entidad educativa]"] <- "apoyo_empleador"
names(base_saludmental)[names(base_saludmental) == "¿qué tanto apoyo siente que ha recibido por parte de las siguientes personas o grupos durante el periodo de cuarentena? [Sus vecinos]"] <- "apoyo_vecinos"
names(base_saludmental)[names(base_saludmental) == "¿qué tanto apoyo siente que ha recibido por parte de las siguientes personas o grupos durante el periodo de cuarentena? [La alcaldía]"] <- "apoyo_alcaldia"
names(base_saludmental)[names(base_saludmental) == "¿qué tanto apoyo siente que ha recibido por parte de las siguientes personas o grupos durante el periodo de cuarentena? [El gobierno nacional]"] <- "apoyo_gobierno"
names(base_saludmental)[names(base_saludmental) == "Sexo"] <- "sexo"
names(base_saludmental)[names(base_saludmental) == "Edad"] <- "edad"
names(base_saludmental)[names(base_saludmental) == "Rango de edad"] <- "rango_edad"
names(base_saludmental)[names(base_saludmental) == "¿Usted, o alguna de las personas con las que convive ha sido diagnosticado con alguna de las siguientes enfermedades: Diabetes, hipertensión, enfermedades cardiacas, asma, enfermedad pulmonar obstructiva crónica, bronquitis o enfisema"] <- "enfermedades_previas"
names(base_saludmental)[names(base_saludmental) == "Nivel educativo"] <- "nivel_educativo"
names(base_saludmental)[names(base_saludmental) == "Localidad de residencia"] <- "localidad"
names(base_saludmental)[names(base_saludmental) == "Situación laboral"] <- "situacion_laboral"
names(base_saludmental)[names(base_saludmental) == "condiciones físicas de su vivienda le han permitido tener tranquilidad y comodidad durante la cuarentena"] <- "comodidad_vivienda"
names(base_saludmental)[names(base_saludmental) == "Personas en el hogar"] <- "personas_hogar"
names(base_saludmental)[names(base_saludmental) == "Personas en el hogar 5 años o menos"] <- "ninos_5_menos"
names(base_saludmental)[names(base_saludmental) == "Personas en el hogar  entre 6 años y 18 años"] <- "ninos_6_18"
names(base_saludmental)[names(base_saludmental) == "Personas en el hogar  entre 19 años y 65 años"] <- "adultos_19_65"
names(base_saludmental)[names(base_saludmental) == "Personas en el hogar  65 años o más"] <- "adultos_65_mas"
names(base_saludmental)[names(base_saludmental) == "¿Considera que ha tenido la oportunidad de expresarle cómo se siente a otras personas?"] <- "expresa_sentimientos"
names(base_saludmental)[names(base_saludmental) == "frecuencia actividad física"] <- "freq_actividad_fisica"
names(base_saludmental)[names(base_saludmental) == "siente que en su casa usted está expuesto a algún tipo de violencia"] <- "violencia_hogar"
names(base_saludmental)[names(base_saludmental) == "¿Usted o alguna de las personas con las que vive ha sido diagnósticado con alguna enfermedad de salud mental que requiera tratamiento?"] <- "diagnostico_salud_mental"
names(base_saludmental)[names(base_saludmental) == "En caso de que la respuesta a la pregunta anterior sea \"\"Sí\"\", ¿ha podido continuar el tratamiento durante el periodo de cuarentena?"] <- "continua_tratamiento"

```

## ¿Saber actuar frente al COVID está asociado con haber sido diagnosticado?

```{r Caso1, echo=TRUE}
## --------------------------------------------
## TABLA Y PRUEBA CHI-CUADRADO
## --------------------------------------------

# Filtrar NA
datos <- base_saludmental %>% 
  filter(!is.na(rango_edad),
         !is.na(expresa_sentimientos))

# Tabla de contingencia
tabla <- table(
  datos$rango_edad,
  datos$expresa_sentimientos
)

tabla

# Prueba Chi-cuadrado
prueba <- chisq.test(tabla, correct = FALSE)

chi_obs <- as.numeric(prueba$statistic)
gl <- as.numeric(prueba$parameter)
p_valor <- prueba$p.value
alpha <- 0.05
chi_critico <- qchisq(1 - alpha, df = gl)


## --------------------------------------------
## INTERVALO DE CONFIANZA PARA DIFERENCIA DE PROPORCIONES
## --------------------------------------------

# Prueba de proporciones para tabla Rx2 (expresa sentimientos)
prop_test <- prop.test(tabla)

IC <- prop_test$conf.int

# Para la diferencia de proporciones “Sí” entre grupos consecutivos
# (opcional — puedes elegir cualquier par de grupos)
propPorGrupo <- prop.table(tabla, 1)[, "Sí"]

# Ejemplo: diferencia entre primer y último grupo
p_dif <- propPorGrupo[length(propPorGrupo)] - propPorGrupo[1]


## --------------------------------------------
## GRÁFICO DE LA DISTRIBUCIÓN CHI-CUADRADO
## --------------------------------------------

library(ggplot2)

x_vals <- seq(0, max(chi_obs, chi_critico) + 10, length.out = 500)
df <- data.frame(
  x = x_vals,
  dens = dchisq(x_vals, df = gl)
)

ggplot(df, aes(x, dens)) +
  geom_line(size = 1.2, color = "black") +

  # Zona crítica
  geom_area(
    data = subset(df, x >= chi_critico),
    aes(x, dens),
    fill = "red", alpha = 0.3
  ) +

  # Línea del valor crítico
  geom_vline(xintercept = chi_critico, color = "red", linetype = "dashed", size = 1.2) +

  # Línea del valor observado
  geom_vline(xintercept = chi_obs, color = "blue", size = 1.3) +

  annotate("text", x = chi_critico, y = dchisq(chi_critico, gl) + 0.005,
           label = paste0("χ² crítico = ", round(chi_critico, 3)),
           color = "red", fontface = "bold", hjust = -0.1) +

  annotate("text", x = chi_obs, y = dchisq(chi_obs, gl) + 0.005,
           label = paste0("χ² observado = ", round(chi_obs, 3)),
           color = "blue", fontface = "bold", hjust = -0.1) +

  labs(
    title = "Distribución Chi-cuadrado\nZona Crítica vs Valor Observado",
    x = expression(chi^2),
    y = "Densidad"
  ) +
  theme_minimal(base_size = 15)


## --------------------------------------------
## DECISIONES
## --------------------------------------------

cat("CHI OBSERVADO =", chi_obs, "\n")
cat("CHI CRÍTICO   =", chi_critico, "\n")
cat("p-valor       =", p_valor, "\n\n")

if (chi_obs > chi_critico) {
  cat("❌ Se RECHAZA H0 por estadístico.\n")
} else {
  cat("✔ No se rechaza H0 por estadístico.\n")
}

if (p_valor < alpha) {
  cat("❌ Se RECHAZA H0 por p-valor.\n")
} else {
  cat("✔ No se rechaza H0 por p-valor.\n")
}

cat("\n")
cat("Diferencia de proporciones (primer vs último grupo) =", round(p_dif, 4), "\n")
cat("IC 95% =", paste(round(IC[1], 4), "a", round(IC[2], 4)), "\n")

if (IC[1] > 0 | IC[2] < 0) {
  cat("❌ El IC NO incluye 0 → hay diferencia significativa.\n")
} else {
  cat("✔ El IC incluye 0 → no hay diferencia significativa.\n")
}
```

##  LA EDAD INFLUYE EN LA CANTIDAD DE DIAGNOSTICADOS

```{r , echo=TRUE}
## ============================================================
## CREAR LOS DOS GRUPOS DE EDAD (15–25) vs (26–35)
## ============================================================

grupo1 <- subset(base_saludmental, edad >= 15 & edad <= 25)
grupo2 <- subset(base_saludmental, edad >= 26 & edad <= 35)

# Proporciones
x1 <- sum(grupo1$diagnosticado_covid == "Sí", na.rm = TRUE)
#x1
n1 <- nrow(grupo1)
#n1

x2 <- sum(grupo2$diagnosticado_covid == "Sí", na.rm = TRUE)
#x2
n2 <- nrow(grupo2)
#n2

p1 <- x1 / n1
p2 <- x2 / n2

cat("Proporcion 15 a 25 años diagnosticados", round(p1, 4))
cat("Proporcion 26 a 35 años diagnosticados", round(p2, 4))
p2

## ============================================================
## PRUEBA DE DIFERENCIA DE PROPORCIONES (Z)
## ============================================================

# Hipótesis:
# H0: p1 = p2
# H1: p1 != p2

p_comb <- (x1 + x2) / (n1 + n2)

z_obs <- (p1 - p2) / sqrt(p_comb * (1 - p_comb) * (1/n1 + 1/n2))
p_valor <- 2 * (1 - pnorm(abs(z_obs)))

z_obs
p_valor

# Valor crítico (α = 0.05)
z_crit <- qnorm(0.975)

z_crit

## ============================================================
## DECISIÓN
## ============================================================

if (abs(z_obs) > z_crit) {
  cat("\n❌ Se RECHAZA H0 por estadístico (cae en zona crítica).\n")
} else {
  cat("\n✔ No se rechaza H0 por estadístico.\n")
}

if (p_valor < 0.05) {
  cat("❌ Se RECHAZA H0 por p-valor (< 0.05).\n")
} else {
  cat("✔ No se rechaza H0 por p-valor.\n")
}

## ============================================================
## INTERVALO DE CONFIANZA 95%
## ============================================================

error <- z_crit * sqrt(p1*(1-p1)/n1 + p2*(1-p2)/n2)

IC_inf <- (p1 - p2) - error
IC_sup <- (p1 - p2) + error

c(IC_inf, IC_sup)

## ============================================================
## GRÁFICO: ZONA CRÍTICA (Distribución Normal)
## ============================================================

x_vals <- seq(-4, 4, length.out = 500)
y_vals <- dnorm(x_vals)

plot(x_vals, y_vals, type="l", lwd=2,
     main="Prueba Z: Zona crítica y valor observado",
     xlab="Z", ylab="Densidad")

# Zona crítica
zc1 <- seq(z_crit, 4, length.out = 200)
zc2 <- seq(-4, -z_crit, length.out = 200)

polygon(c(zc1, rev(zc1)), c(dnorm(zc1), rep(0, length(zc1))),
        col=rgb(1, 0, 0, 0.3), border=NA)

polygon(c(zc2, rev(zc2)), c(dnorm(zc2), rep(0, length(zc2))),
        col=rgb(1, 0, 0, 0.3), border=NA)

# Líneas críticas
abline(v = z_crit, col="red", lwd=2, lty=2)
abline(v = -z_crit, col="red", lwd=2, lty=2)

# Valor observado
abline(v = z_obs, col="blue", lwd=3)

text(z_obs, dnorm(z_obs) + 0.01,
     paste("z observado =", round(z_obs, 3)),
     col="blue", pos=3)

text(z_crit, dnorm(z_crit) + 0.01,
     paste("z crítico =", round(z_crit, 3)),
     col="red", pos=3)

legend("topright",
       legend=c("Curva normal", "Zona crítica", "z crítico", "z observado"),
       col=c("black", rgb(1,0,0,0.3), "red", "blue"),
       lwd=c(2,10,2,3), bty="n")
```

## ¿La actividad física está asociada con sentirse decaído/deprimido?

```{r , echo=TRUE}
## ============================================================
## TABLA Y PRUEBA CHI-CUADRADO
## ============================================================

tabla <- table(base_saludmental$freq_actividad_fisica,
               base_saludmental$decaido_deprimido)

tabla

# Prueba Chi² sin corrección
prueba <- chisq.test(tabla, correct = FALSE)
prueba

chi_obs <- prueba$statistic
gl <- prueba$parameter
p_valor <- prueba$p.value

# Valor crítico (α = 0.05)
chi_crit <- qchisq(0.95, df = gl)

chi_obs
chi_crit
p_valor

## ============================================================
## DECISIÓN
## ============================================================

if (chi_obs > chi_crit) {
  cat("\n❌ Se RECHAZA H0 por estadístico (zona crítica).\n")
} else {
  cat("\n✔ No se rechaza H0 por estadístico.\n")
}

if (p_valor < 0.05) {
  cat("❌ Se RECHAZA H0 por p-valor (< 0.05).\n")
} else {
  cat("✔ No se rechaza H0 por p-valor.\n")
}

## ============================================================
## INTERVALO DE CONFIANZA (comparación dos proporciones)
## ============================================================

## Elegir automáticamente niveles extremos de actividad física
niveles <- levels(base_saludmental$freq_actividad_fisica)

nivel_bajo <- niveles[1]
nivel_alto <- niveles[length(niveles)]

# Contar “decaído/deprimido = Mucho más que antes / Un poco más que antes”
# Puedes ajustar si usas un valor diferente
niveles_depresion_alta <- c("Mucho más que antes", "Un poco más que antes")

x1 <- sum(base_saludmental$freq_actividad_fisica == nivel_bajo &
            base_saludmental$decaido_deprimido %in% niveles_depresion_alta)

n1 <- sum(base_saludmental$freq_actividad_fisica == nivel_bajo)

x2 <- sum(base_saludmental$freq_actividad_fisica == nivel_alto &
            base_saludmental$decaido_deprimido %in% niveles_depresion_alta)

n2 <- sum(base_saludmental$freq_actividad_fisica == nivel_alto)


## ----------- VERIFICACIÓN PARA EVITAR ERROR --------------
if (n1 == 0 | n2 == 0) {
  
  cat("\n⚠️ No se puede calcular el intervalo de confianza.\n")
  cat("Motivo: uno de los niveles NO tiene observaciones.\n\n")
  
  cat("Valores:\n")
  cat("Nivel bajo:", nivel_bajo, "| n1 =", n1, "\n")
  cat("Nivel alto:", nivel_alto, "| n2 =", n2, "\n")
  
} else {
  
  cat("\nCálculo del inte

```

## ¿La edad de las personas está relacionada con la oportunidad de expresarle a otros cómo se sienten durante la pandemia?

```{r , echo=FALSE}

## --------------------------------------------------------
## PREPARACIÓN DE DATOS
## --------------------------------------------------------

# Filtrar NA y asegurar que la variable sí exista
datos <- base_saludmental %>% 
  filter(!is.na(edad),
         !is.na(expresa_sentimientos))

# Revisar niveles
table(datos$expresa_sentimientos)

## --------------------------------------------------------
## DESCRIPTIVOS POR GRUPO
## --------------------------------------------------------

descriptivos <- datos %>%
  group_by(expresa_sentimientos) %>%
  summarise(
    media_edad = mean(edad, na.rm = TRUE),
    sd_edad = sd(edad, na.rm = TRUE),
    n = n()
  )
descriptivos

## --------------------------------------------------------
## PRUEBA T DE DIFERENCIA DE MEDIAS
## --------------------------------------------------------

ttest <- t.test(edad ~ expresa_sentimientos,
                data = datos,
                var.equal = FALSE)

t_obs <- as.numeric(ttest$statistic)
gl <- as.numeric(ttest$parameter)
p_valor <- ttest$p.value
IC <- ttest$conf.int
alpha <- 0.05
t_critico <- qt(1 - alpha/2, df = gl)

## --------------------------------------------------------
## GRÁFICO DE LA DISTRIBUCIÓN t
## --------------------------------------------------------

# --- Datos de la prueba t ya calculados anteriormente ---
t_value <- ttest$statistic
df <- ttest$parameter
p_value <- ttest$p.value

# t crítico para alfa = 0.05 (dos colas)
t_crit <- qt(0.975, df = df)

# Datos para la curva t
x_vals <- seq(-5, 5, length.out = 1000)
df_plot <- data.frame(x = x_vals,
                      y = dt(x_vals, df = df))

ggplot(df_plot, aes(x, y)) +
  geom_line(color = "black", size = 1) +

  # --- Zona crítica ---
  geom_area(data = subset(df_plot, x <= -t_crit),
            aes(x, y), fill = "red", alpha = 0.3) +
  geom_area(data = subset(df_plot, x >=  t_crit),
            aes(x, y), fill = "red", alpha = 0.3) +

  # --- Líneas de t crítico ---
  geom_vline(xintercept = c(-t_crit, t_crit),
             color = "red", linetype = "dashed", size = 1) +

  # --- Línea t observado ---
  geom_vline(xintercept = t_value,
             color = "blue", size = 1.3) +

  # --- Texto explicativo ---
  annotate("text", x = t_value, y = 0.38,
           label = paste("t observado =", round(t_value, 3)),
           color = "blue", vjust = -0.5, size = 5) +

  annotate("text", x =  t_crit, y = 0.32,
           label = paste("t crítico =", round(t_crit, 3)),
           color = "red", size = 5, hjust = -0.2) +

  annotate("text", x = -t_crit, y = 0.32,
           label = paste("t crítico =", round(-t_crit, 3)),
           color = "red", size = 5, hjust = 1.2) +

  # Leyenda manual
  annotate("text", x = 0, y = 0.42,
           label = "Curva t\nZona crítica\n t crítico\n t observado",
           hjust = 0, size = 5) +

  labs(
    title = "Prueba t: Zona crítica y valor observado",
    x = "t",
    y = "Densidad"
  ) +
  theme_minimal(base_size = 15)

## --------------------------------------------------------
## DECISIONES DE LA PRUEBA
## --------------------------------------------------------

cat("t OBSERVADO =", round(t_obs, 4), "\n")
cat("t CRÍTICO   =", round(t_critico, 4), "\n")
cat("p-valor     =", round(p_valor, 4), "\n\n")

if (abs(t_obs) > t_critico) {
  cat("❌ Se RECHAZA H0 por estadístico.\n")
} else {
  cat("✔ No se rechaza H0 por estadístico.\n")
}

if (p_valor < alpha) {
  cat("❌ Se RECHAZA H0 por p-valor.\n")
} else {
  cat("✔ No se rechaza H0 por p-valor.\n")
}

cat("\nIntervalo de confianza 95% para (media1 - media2):\n")
cat(round(IC[1], 4), "a", round(IC[2], 4), "\n")

if (IC[1] > 0 | IC[2] < 0) {
  cat("❌ El IC NO incluye 0 → hay diferencia significativa en la edad.\n")
} else {
  cat("✔ El IC incluye 0 → no hay diferencia significativa en la edad.\n")
}

```



